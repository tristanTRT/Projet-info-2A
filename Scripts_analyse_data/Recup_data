import pandas as pd
import os
import s3fs
from dotenv import load_dotenv

# Charger les variables d'environnement
load_dotenv()

# --- Configuration S3 ---
BUCKET_NAME = "tristant"
S3_PREFIX = "diffusion" 
S3_ENDPOINT = os.getenv("AWS_S3_ENDPOINT", "minio.lab.sspcloud.fr")
S3_URL = f"https://{S3_ENDPOINT}"

# Options pour pandas + s3fs : Accès anonyme
storage_options = {
    "client_kwargs": {"endpoint_url": S3_URL}
    # Les clés, secret et token sont omis pour l'accès public/anonyme
}

FILES = [
    "dfs_games.parquet", 
    "games_blitz.parquet",
    "games_rapid.parquet",
    "games_bullet.parquet",
    "games_classical.parquet",
    # Ajoutez les autres fichiers 'users_xxx.parquet' si vous voulez aussi les lire ici
]

def read_all_games_without_listing():
    dfs = []

    for file in FILES:
        # Construire le chemin S3 complet
        s3_path = f"s3://{BUCKET_NAME}/{S3_PREFIX}/{file}"
        
        # Extraire le format de partie
        format_partie = file.replace("games_", "").replace(".parquet", "")

        try:
            # Lecture directe sans lister le bucket (accès anonyme)
            df = pd.read_parquet(s3_path, storage_options=storage_options)
            
            # Ajout de la colonne 'format_partie' uniquement aux DataFrames de jeux
            if file.startswith("games_"):
                df["format_partie"] = format_partie
            
            dfs.append(df)
            print(f"✅ Lu : {s3_path}")

        except Exception as e:
            # Si l'erreur persiste, cela signifie que soit le fichier n'existe pas,
            # soit la politique d'accès publique n'est pas active.
            print(f"❌ Erreur sur {s3_path} (Vérifiez l'URL ou la permission publique) : {e}")

    # Concaténation des DataFrames de jeux seulement
    game_dfs = [df for df in dfs if 'format_partie' in df.columns]
    
    if game_dfs:
        df_total = pd.concat(game_dfs, ignore_index=True)
        print(f"\nImport terminé : {len(df_total)} parties au total (jeux)")
        return df_total
    elif dfs:
        print("Les fichiers lus n'étaient pas des jeux à concaténer.")
        return dfs[0]
    else:
        print("Aucun fichier importé.")
        return pd.DataFrame()

if __name__ == "__main__":
    df_all = read_all_games_without_listing()
    print("\nAperçu :")
    print(df_all.head())